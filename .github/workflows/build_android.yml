name: "[Android] Build TF Examples"

on:
  push:

jobs:
  android:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2019, windows-2022]

    runs-on: ${{ matrix.os }}

    - name: Checkout The-Forge
      uses: actions/checkout@v3
      with:
        path: The-Forge

    - name: Checkout Custom-Middleware
      uses: actions/checkout@v3
      with:
        path: Custom-Middleware
        repository: ConfettiFX/Custom-Middleware
        # ref: ${{ github.ref_name }}  # Checkout the Custom-Middleware branch with the same name as the The-Forge branch we're building

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2.0.8
    - name: Install Android NDK
      shell: cmd
      run: sdkmanager.bat --install "ndk;21.4.7075529"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install Vulkan SDK
      run: choco install vulkan-sdk --version 1.2.162.0

    - name: Install VS2017
      run: choco install VisualStudio2017Community visualstudio2017-workload-nativedesktop visualstudio2017-workload-nativemobile

    - name: Install Android Game Development Extension
      shell: pwsh
      env:
        TEMP: ${{ runner.temp }}
      run: |
        Write-Host "Downloading AGDE..."
        Invoke-WebRequest https://dl.google.com/android/agde/release/62/20220615-181705/AndroidGameDevelopmentExtensionSetup-v22.2.65.exe -OutFile agde_setup.exe
        Write-Host "Starting AGDE installer..."
        ./agde_setup.exe -quiet
        Write-Host "Waiting for AGDE installer to close..."
        Wait-Process agde_setup

        Write-Host "Dumping TEMP log files ($env:TEMP) :"
        $logFiles = Get-ChildItem -Path $env:TEMP -Filter "*.log"
        $logFiles
        foreach ($logFile in $logFiles) {
            Write-Host "`n`n`n`n=================== Dumping log file ${logFile} ===================`n`n`n`n"

            $fileContents = Get-Content $logFile.FullName -Raw
            Write-Host $fileContents
        }

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      with:
        vs-version: '[15.0,16.0)'

    - name: Build
      working-directory: The-Forge
      shell: cmd
      run: python -u ./CI/PyBuild.py --preserveworkingdir --prebuild --android --printbuildoutput
      env:
        VULKAN_SDK: "C:\\VulkanSDK\\1.2.162.0"
